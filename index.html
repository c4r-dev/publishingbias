<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intuition for Publication Bias</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.0/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
            font-family: Arial, sans-serif;
        }

        h1 {
            text-align: center;
            margin: 10px 0;
            font-size: calc(1.5rem + 1vw); /* Responsive font size */
        }

        #slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
            width: 90%; /* Ensure container adapts to screen size */
        }

        input[type="range"] {
            width: 100%;
            max-width: 500px; /* Allow flexibility for larger screens */
        }

        label {
            font-size: calc(1rem + 0.3vw); /* Responsive font size */
            text-align: center;
        }

        #plot {
            width: 95%; /* Take full width on smaller screens */
            height: 70vh; /* Adjusted height for better mobile fit */
            max-height: 700px; /* Limit max height for very large screens */
        }

        @media (max-width: 600px) {
            #plot {
                height: 60vh; /* Slightly smaller height on small devices */
            }
        }
    </style>
</head>
<body>
    <h1>Intuition for Publication Bias</h1>
    <div id="slider-container">
        <label for="s2-slider">% of unpublished null/ not significant/negative effects: <span id="s2-value">0</span></label>
        <input type="range" id="s2-slider" min="0" max="1" step="0.01" value="0">
    </div>
    <div id="plot"></div>
    <script type="text/javascript">
        async function main() {
            const pyodide = await loadPyodide();

            const plotDiv = document.getElementById("plot");
            const slider = document.getElementById("s2-slider");
            const s2Value = document.getElementById("s2-value");

            await pyodide.loadPackage("micropip");
            const micropip = pyodide.pyimport("micropip");
            await micropip.install("pandas");
            await micropip.install("numpy");
            await micropip.install("plotly");

            async function updatePlot(s2) {
                const pythonCode = `
import numpy as np
import plotly.graph_objects as go
import plotly.subplots as sp
import json

def numpy_to_list(obj):
    if isinstance(obj, np.ndarray):
        return obj.tolist()
    elif isinstance(obj, dict):
        return {key: numpy_to_list(value) for key, value in obj.items()}
    elif isinstance(obj, list):
        return [numpy_to_list(item) for item in obj]
    else:
        return obj

def plot_bias(s2):
    s = 1 - s2

    dark_blue = "#1f77b4"
    dark_orange = "#ff7f0e"

    x1 = np.linspace(-3, 3, 500)
    y1 = np.exp(-0.5 * x1**2) / np.sqrt(2 * np.pi)
    avg_z1 = 0  # Mean of a standard normal distribution is 0

    x2 = np.linspace(-3, 3, 500)
    y2 = np.exp(-0.5 * x2**2)
    y2[x2 < 2] *= s
    y2 /= np.trapz(y2, x2)
    avg_z2 = np.trapz(x2 * y2, x2)

    bar_x = ["p<0.05, neg", "NS, neg", "NS, pos", "p<0.05, pos"]
    bar_y1 = [0.025, 0.475, 0.475, 0.025]
    bar_y2 = bar_y1[:]
    bar_y2[:3] = [val * s for val in bar_y1[:3]]
    bar_y2 = [val / sum(bar_y2) for val in bar_y2]

    fig = sp.make_subplots(
        rows=4,
        cols=1,
        shared_xaxes=False,
        vertical_spacing=0.25,  # Increased spacing between plots
        subplot_titles=(
            "Distribution of Real Effects",
            "Distribution of Published Papers",
            "Significance of Experiments",
            "Significance of Published Papers"
        )
    )

    fig.add_trace(go.Scatter(x=x1, y=y1, mode='lines', line=dict(color=dark_blue), name="Real Effects"), row=1, col=1)
    fig.add_trace(go.Scatter(x=x2, y=y2, mode='lines', line=dict(color=dark_orange), name="Published Papers"), row=2, col=1)
    fig.add_trace(go.Bar(x=bar_x, y=bar_y1, marker_color=dark_blue, name="Significance of Experiments"), row=3, col=1)
    fig.add_trace(go.Bar(x=bar_x, y=bar_y2, marker_color=dark_orange, name="Significance of Published Papers"), row=4, col=1)

    fig.update_layout(
        height=900,
        margin=dict(t=100, b=50, l=50, r=50),
        title_x=0.5,
        showlegend=False,
        xaxis=dict(title=dict(standoff=20)),  # Add spacing for x-axis title
        xaxis2=dict(title=dict(standoff=20)),  # Add spacing for x-axis title
    )

    # Add average Z-score annotations to the first two plots
    fig.add_annotation(
        x=2.5, y=max(y1) * 0.8, xref="x1", yref="y1",
        text=f"Avg Z: {avg_z1:.2f}",
        showarrow=False,
        font=dict(size=12, color="red")
    )
    fig.add_annotation(
        x=2.5, y=max(y2) * 0.8, xref="x2", yref="y2",
        text=f"Avg Z: {avg_z2:.2f}",
        showarrow=False,
        font=dict(size=12, color="red")
    )

    fig.update_xaxes(title_text="Z-score (mean/std)", row=1, col=1)
    fig.update_xaxes(title_text="Z-score (mean/std)", row=2, col=1)

    fig_dict = fig.to_dict()
    clean_fig_dict = numpy_to_list(fig_dict)

    return json.dumps(clean_fig_dict)

plot_bias(${s2})
                `;
                try {
                    const plotJSON = await pyodide.runPythonAsync(pythonCode);

                    const plotData = JSON.parse(plotJSON);

                    plotDiv.innerHTML = "";

                    Plotly.newPlot(plotDiv, plotData.data, plotData.layout, { responsive: true });
                } catch (error) {
                    console.error("Error generating Plotly plot:", error);
                    plotDiv.innerHTML = "<p style='color:red;'>Error generating plot. Check console for details.</p>";
                }
            }

            slider.addEventListener("input", async () => {
                const s2 = slider.value;
                s2Value.textContent = s2;
                await updatePlot(s2);
            });

            await updatePlot(slider.value);
        }

        main();
    </script>
</body>
</html>
